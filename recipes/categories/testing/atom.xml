<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Testing | tempus-fugit]]></title>
  <link href="http://tempusfugitlibrary.org/recipes/categories/testing/atom.xml" rel="self"/>
  <link href="http://tempusfugitlibrary.org/"/>
  <updated>2014-03-03T17:52:46+00:00</updated>
  <id>http://tempusfugitlibrary.org/</id>
  <author>
    <name><![CDATA[Toby Weston]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Wait for UI Elements in Tests]]></title>
    <link href="http://tempusfugitlibrary.org/recipes/2013/03/17/wait-for-ui-element/"/>
    <updated>2013-03-17T14:56:00+00:00</updated>
    <id>http://tempusfugitlibrary.org/recipes/2013/03/17/wait-for-ui-element</id>
    <content type="html"><![CDATA[<p>When a UI asynchronously updates a value, it can be difficult to make assertions in tests reliably. There are typically two approaches to solving this, either poll the UI until the value matches the assertion (timing out after a certain amount of time) or make the UI notify your test code that a value has changed.</p>

<p>Using the <code>WaitFor</code> class along with <a href="http://docs.seleniumhq.org/docs/03_webdriver.jsp#">Web Driver</a> allows you to do the former with something like this.</p>

<!-- more -->


<h2>Wait for a Condition</h2>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WaitFor</span><span class="o">.</span><span class="na">waitOrTimeout</span><span class="o">(</span><span class="k">new</span> <span class="n">Condition</span><span class="o">()</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSatisfied</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ui</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">&quot;result&quot;</span><span class="o">)).</span><span class="na">getText</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;100 matches&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;},</span> <span class="n">timeout</span><span class="o">(</span><span class="n">millis</span><span class="o">(</span><span class="mi">250</span><span class="o">)))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This creates an implicit assertion. If the <code>Condition</code> returns <code>true</code> after any number of attempts, the test code continues without incident. If, however, it doesn't find the value within the timeout, a <code>TimeoutException</code> will be thrown failing your test.</p>

<h2>Wait for an Assertion</h2>

<p>In <a href="https://oss.sonatype.org/content/repositories/snapshots/com/google/code/tempus-fugit/tempus-fugit/1.2-SNAPSHOT/">tempus-fugit 1.2</a>, there's a new method on <code>WaitFor</code> to convert the <code>TimeoutException</code> above into a JUnit failure.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">waitFor</span><span class="o">(</span><span class="n">SelfDescribingCondition</span> <span class="n">condition</span><span class="o">,</span> <span class="n">Timeout</span> <span class="n">timeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">waitOrTimeout</span><span class="o">(</span><span class="n">condition</span><span class="o">,</span> <span class="n">failOnTimeout</span><span class="o">(</span><span class="n">condition</span><span class="o">),</span> <span class="n">timeout</span><span class="o">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Combine it with <code>Conditions.assertion</code> to periodically query the UI and compare it against a Hamcrest <code>Matcher</code>. For example,</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">waitFor</span><span class="o">(</span><span class="n">assertion</span><span class="o">(</span><span class="n">getResultFrom</span><span class="o">(</span><span class="n">ui</span><span class="o">),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;100 matches&quot;</span><span class="o">)),</span> <span class="n">timeout</span><span class="o">(</span><span class="n">millis</span><span class="o">(</span><span class="mi">250</span><span class="o">)));</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>where, <code>getResultFrom(ui)</code> returns an instance of <code>ProbeFor&lt;T&gt;</code> (a self describing <code>Callable</code> used to query the UI for a <code>T</code>).</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">ProbeFor</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">getResultFrom</span><span class="o">(</span><span class="kd">final</span> <span class="n">UI</span> <span class="n">ui</span><span class="o">)</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">return</span> <span class="k">new</span> <span class="n">ProbeFor</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">String</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RuntimeException</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ui</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">&quot;result&quot;</span><span class="o">)).</span><span class="na">getText</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">describeTo</span><span class="o">(</span><span class="n">Description</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">description</span><span class="o">.</span><span class="na">appendText</span><span class="o">(</span><span class="s">&quot;&#39;number of results&#39; field in the UI&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Turn Timeouts into AssertionErrors</h2>

<p>Now rather than fail with a <code>TimeoutException</code>, if the assertion hasn't matched before the timeout expires, a regular JUnit failure (<code>AssertionError</code>) will be thrown. In the IDE, it'll look something like this.</p>

<pre><code>java.lang.AssertionError: 'number of results' field in the UI
Expected: is "100 matches"
     but: &lt;was ""&gt;, &lt;was ""&gt;, &lt;was ""&gt;, &lt;was ""&gt;, &lt;was "200 matches"&gt;
</code></pre>

<p>The <code>describeTo</code> method describes the probe and the <code>Matcher</code> describes what was expected. Because the UI was polled several times, each value was displayed in the 'but was' section. On the fifth attempt, a value was found but it didn't match the expectation.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Testing Concurrent Code]]></title>
    <link href="http://tempusfugitlibrary.org/recipes/2012/05/20/testing-concurrent-code/"/>
    <updated>2012-05-20T20:33:00+01:00</updated>
    <id>http://tempusfugitlibrary.org/recipes/2012/05/20/testing-concurrent-code</id>
    <content type="html"><![CDATA[<p>Testing concurrency can be hard. When you fire up threads from within a test, it's difficult not to introduce concurrency bugs in the test code and be sure you're actually exercising the code with the intended interleaving. There must be a better way...</p>

<h2>Separate the Concurrency Policy from Behaviour</h2>

<p><a href="http://www.growing-object-oriented-software.com/">GOOS</a> amongst other people recommend separating the concurrency policy from the parts of the system that are doing the work. So, for example, if you have some form of "executor" which is responsible for farming work out concurrently and behaviour defined separately, you can test each independently and just verify that they collaborate to achieve "worker" behaviour concurrently. Make sense?</p>

<!-- more -->


<p>As an example, <a href="https://github.com/tobyweston/tempus-fugit/blob/master/tempus-fugit/src/test/java/com/google/code/tempusfugit/concurrency/ConcurrentSchedulerTest.java">this test from tempus-fugit</a> demonstrates the idea. The <code>Scheduler</code>'s behaviour (which is essentially to "schedule" tasks) is independent from <em>how</em> it actually achieves this. In this case, it delegates to an <code>Executor</code> and so this doesn't need to be tested with any threads. It's a simple collaborator style test.</p>

<p>Having said that, there may be times you actually want to run your class 'in context' in a multi-threaded way. The trick here is to keep the test deterministic. Well, I say that, there's a couple of choices...</p>

<h2>Deterministic</h2>

<p>If you can setup your test to progress in a deterministic way, waiting at key points for conditions to be met before moving forward, you can try to simulate a specific process interleaving to test. This means understanding exactly what you want to test (for example, forcing the code into a deadlock) and stepping through deterministically (for example, using abstractions like <code>CountdownLatch</code> to <em>synchronise</em> the moving parts).</p>

<p>When you attempt to make some multi-threaded test syncrhonise its moving parts, you can use whatever concurrency abstraction is available to you but it's difficult because its concurrent; things could happen in an unexpected order. Often people try to mitigate this in tests by introducing <code>sleep</code> calls. We generally don't like to sleep in a test because it can introduce non-determinism. Just because the right sleep amount on one machine <em>usually</em> causes the affect you're looking for, it doesn't mean it'll be the same on the next machine. It'll also make the test run slower and when you've got thousands of tests to run, every ms counts. If you try and lower the sleep period, more non-determinism comes in. It's not pretty.</p>

<p>Some examples of forcing specific interleaving include</p>

<ul>
<li><a href="https://github.com/tobyweston/tempus-fugit/blob/master/tempus-fugit/src/test/java/com/google/code/tempusfugit/concurrency/DeadlockDetectorTest.java">Forcing a deadlock</a> using <code>CountdownLatch</code></li>
<li><a href="https://github.com/tobyweston/tempus-fugit/blob/master/tempus-fugit/src/test/java/com/google/code/tempusfugit/concurrency/ThreadUtilsTest.java">Setting up a thread to be interrupted</a></li>
</ul>


<p>Another gotcha is where the main test thread will finish before any newly spawned threads under test complete. This is an easy trap to fall into with UI testing. Waiting for a specific condition rather than allowing the test thread to finish often helps. For example using <a href="/documentation/time/waiting">WaitFor</a>. See the article <a href="http://baddotrobot.com/blog/2008/12/30/be-explicit-about-ui-thread-in-swt/">Be Explicit with the UI Thread</a> for more details around this for UI testing.</p>

<h2>Soak / Load Testing</h2>

<p>Another choice is to bombard your classes in an attempt to overload them and force them to betray some subtle concurrency issue. Here, just as in the other style, you'll need to setup up specific assertions so that you can tell if and when the classes betray themselves. Of course there is no guarantee that you'll simulate a problem, you might never see the unlike timing needed.</p>

<p>The tempus-fugit library offers a declarative way to setup tests to run repeatedly and in parallel, see <a href="/documentation/junit/load">Load / Soak Tests</a>.</p>
]]></content>
  </entry>
  
</feed>
