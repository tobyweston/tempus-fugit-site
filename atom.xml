<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[tempus-fugit]]></title>
  <link href="http://tempusfugitlibrary.org/atom.xml" rel="self"/>
  <link href="http://tempusfugitlibrary.org/"/>
  <updated>2014-03-03T17:52:46+00:00</updated>
  <id>http://tempusfugitlibrary.org/</id>
  <author>
    <name><![CDATA[Toby Weston]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Wait for UI Elements in Tests]]></title>
    <link href="http://tempusfugitlibrary.org/recipes/2013/03/17/wait-for-ui-element/"/>
    <updated>2013-03-17T14:56:00+00:00</updated>
    <id>http://tempusfugitlibrary.org/recipes/2013/03/17/wait-for-ui-element</id>
    <content type="html"><![CDATA[<p>When a UI asynchronously updates a value, it can be difficult to make assertions in tests reliably. There are typically two approaches to solving this, either poll the UI until the value matches the assertion (timing out after a certain amount of time) or make the UI notify your test code that a value has changed.</p>

<p>Using the <code>WaitFor</code> class along with <a href="http://docs.seleniumhq.org/docs/03_webdriver.jsp#">Web Driver</a> allows you to do the former with something like this.</p>

<!-- more -->


<h2>Wait for a Condition</h2>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WaitFor</span><span class="o">.</span><span class="na">waitOrTimeout</span><span class="o">(</span><span class="k">new</span> <span class="n">Condition</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSatisfied</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ui</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">&quot;result&quot;</span><span class="o">)).</span><span class="na">getText</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;100 matches&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">},</span> <span class="n">timeout</span><span class="o">(</span><span class="n">millis</span><span class="o">(</span><span class="mi">250</span><span class="o">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This creates an implicit assertion. If the <code>Condition</code> returns <code>true</code> after any number of attempts, the test code continues without incident. If, however, it doesn&#8217;t find the value within the timeout, a <code>TimeoutException</code> will be thrown failing your test.</p>

<h2>Wait for an Assertion</h2>

<p>In <a href="https://oss.sonatype.org/content/repositories/snapshots/com/google/code/tempus-fugit/tempus-fugit/1.2-SNAPSHOT/">tempus-fugit 1.2</a>, there&#8217;s a new method on <code>WaitFor</code> to convert the <code>TimeoutException</code> above into a JUnit failure.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">waitFor</span><span class="o">(</span><span class="n">SelfDescribingCondition</span> <span class="n">condition</span><span class="o">,</span> <span class="n">Timeout</span> <span class="n">timeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">waitOrTimeout</span><span class="o">(</span><span class="n">condition</span><span class="o">,</span> <span class="n">failOnTimeout</span><span class="o">(</span><span class="n">condition</span><span class="o">),</span> <span class="n">timeout</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Combine it with <code>Conditions.assertion</code> to periodically query the UI and compare it against a Hamcrest <code>Matcher</code>. For example,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">waitFor</span><span class="o">(</span><span class="n">assertion</span><span class="o">(</span><span class="n">getResultFrom</span><span class="o">(</span><span class="n">ui</span><span class="o">),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;100 matches&quot;</span><span class="o">)),</span> <span class="n">timeout</span><span class="o">(</span><span class="n">millis</span><span class="o">(</span><span class="mi">250</span><span class="o">)));</span>
</span></code></pre></td></tr></table></div></figure>


<p>where, <code>getResultFrom(ui)</code> returns an instance of <code>ProbeFor&lt;T&gt;</code> (a self describing <code>Callable</code> used to query the UI for a <code>T</code>).</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">ProbeFor</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">getResultFrom</span><span class="o">(</span><span class="kd">final</span> <span class="n">UI</span> <span class="n">ui</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="n">ProbeFor</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="n">String</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RuntimeException</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">ui</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">&quot;result&quot;</span><span class="o">)).</span><span class="na">getText</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">describeTo</span><span class="o">(</span><span class="n">Description</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">description</span><span class="o">.</span><span class="na">appendText</span><span class="o">(</span><span class="s">&quot;&#39;number of results&#39; field in the UI&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">};</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Turn Timeouts into AssertionErrors</h2>

<p>Now rather than fail with a <code>TimeoutException</code>, if the assertion hasn&#8217;t matched before the timeout expires, a regular JUnit failure (<code>AssertionError</code>) will be thrown. In the IDE, it&#8217;ll look something like this.</p>

<pre><code>java.lang.AssertionError: 'number of results' field in the UI
Expected: is "100 matches"
     but: &lt;was ""&gt;, &lt;was ""&gt;, &lt;was ""&gt;, &lt;was ""&gt;, &lt;was "200 matches"&gt;
</code></pre>

<p>The <code>describeTo</code> method describes the probe and the <code>Matcher</code> describes what was expected. Because the UI was polled several times, each value was displayed in the &#8216;but was&#8217; section. On the fifth attempt, a value was found but it didn&#8217;t match the expectation.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Optimise the Number of Threads]]></title>
    <link href="http://tempusfugitlibrary.org/recipes/2012/07/12/optimise-the-number-of-threads/"/>
    <updated>2012-07-12T19:01:00+01:00</updated>
    <id>http://tempusfugitlibrary.org/recipes/2012/07/12/optimise-the-number-of-threads</id>
    <content type="html"><![CDATA[<p>Working out the theoretical optimal number of threads you should use for your application is fairly straightforward. You do, however, need to understand your applications runtime characteristics. Is it mostly occupied with CPU intensive work or is it mostly waiting for IO? A <a href="http://www.yourkit.com/">good profiler</a> will help you to understand your applications profile.</p>

<!-- more -->


<h2>CPU Bound Tasks</h2>

<p>For CPU bound tasks, Goetz (2002, 2006.) recommends</p>

<pre><code>threads = number of CPUs + 1
</code></pre>

<p>Which is intuitive as if a CPU is being kept busy, we can&#8217;t do more work than the number of CPUs. Goetz purports that the additional CPU has been shown as an improvement over omitting it (2006.), but others don&#8217;t agree and suggest the number of CPUs is optimal.</p>

<h2>IO Bound Tasks</h2>

<p>Working out the optimal number for IO bound tasks is less obvious. During an IO bound task, a CPU will be left idle (waiting or blocking). This idle time can be better used in initiating another IO bound request.</p>

<p>Subramaniam (2011, p.31) describes the optimal number of threads in terms of the following formula.</p>

<pre><code>threads = number of cores /  (1 – blocking coefficient)
</code></pre>

<p><img src="../../../../../images/subramaniam.gif"></p>

<p>And Goetz (2002) describes the optimal number of threads in terms of the following.</p>

<pre><code>threads = number of cores * (1 + wait time / service time)
</code></pre>

<p><img src="../../../../../images/goetz.gif"></p>

<p>Where we can think of <code>wait time / service</code> time as a measure of how contended the task is.</p>

<h2>Goetz and Subramaniam Agree</h2>

<p>Just out of interest, we can show that both IO bound formulas are equivalent. Starting with Goetz’s formula, we assert that <code>w+s=1</code> and remove the service time (<code>s</code>) giving the following</p>

<p><img src="../../../../../images/goetz-2.gif"></p>

<p>We can continue by multiplying both sides by <code>1-w</code> reducing the right hand side to <code>c</code> before reversing the operation and revealing Subramaniam’s expression.</p>

<p><img src="../../../../../images/goetz-3.gif"></p>

<p><img src="../../../../../images/goetz-4.gif"></p>

<p><img src="../../../../../images/subramaniam.gif"></p>

<p>Thanks to <a href="https://twitter.com/Jazzatola">Jazzatola</a> for mathematical input.</p>

<h2>References</h2>

<ul>
<li>Goetz, B. 2002. <a href="http://www.ibm.com/developerworks/java/library/j-jtp0730/index.html">Java theory and practice: Thread pools and work queues</a>. IBM DeveloperWorks.</li>
<li>Goetz, B. Peierls, T. Bloch, J. Bowbeer, J. Holmes, D. and Lea, D. 2006. <a href="http://amzn.to/NrXQPZ">Java Concurrency in Practice</a>. 1st Edition. Addison Wesley.</li>
<li>Subramaniam, V. 2011. <a href="http://amzn.to/NrXXuI">Programming Concurrency on the JVM</a>. 1st Edition. Pragmatic Bookshelf.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Handling Interrupt Exceptions]]></title>
    <link href="http://tempusfugitlibrary.org/recipes/2012/06/30/handling-interrupt-exceptions/"/>
    <updated>2012-06-30T13:01:00+01:00</updated>
    <id>http://tempusfugitlibrary.org/recipes/2012/06/30/handling-interrupt-exceptions</id>
    <content type="html"><![CDATA[<p>How should you handle <code>InterruptedException</code>s?</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// what to do?</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<p>You could rethrow if it&#8217;s appropriate but often its not. If that&#8217;s the case, you should set the <em>interrupt status</em> flag associated with the current thread. For example,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span> <span class="c1">// reset the interrupt status</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Typically, if a Java method throws <code>InterruptedException</code>, it will have reset the <em>interrupt status</em> before doing so. In the example above, you&#8217;re just restoring it and preserving a flag to indicate the thread had once been interrupted.</p>

<p>The reason for preserving this status flag is in case code other than your own depends on it. For example, a framework (which you may not appreciate is actually being used), may be doing something like the following to (correctly) support interruption.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">while</span> <span class="o">(!</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">process</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You should generally never just catch the exception and ignore it; it may cripple code depending on the status flag for correct behaviour. In the same way, it&#8217;s rarely a good idea to catch and exception and <a href="http://baddotrobot.com/blog/2010/10/18/logging-is-evil-but/">just log it</a>, especially in the case of <code>InterruptedException</code>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Avoid JMock Finaliser Problems]]></title>
    <link href="http://tempusfugitlibrary.org/recipes/2012/06/01/avoid-jmock-finaliser-problems/"/>
    <updated>2012-06-01T23:22:00+01:00</updated>
    <id>http://tempusfugitlibrary.org/recipes/2012/06/01/avoid-jmock-finaliser-problems</id>
    <content type="html"><![CDATA[<p>The default threading policy for a JMock <code>Mockery</code> warns if the mockery is being used by multiple threads. The <code>SingleThreadedPolicy</code> will output the following.</p>

<pre><code>2012-05-31 07:35:35 ERROR Finalizer [Console$Logger] - the Mockery is not thread-safe: use a Synchroniser to ensure thread safety
</code></pre>

<p>If you really need multi-threaded access to the mockery, it&#8217;s a <a href="http://tempusfugitlibrary.org/recipes/2012/06/01/making-jmock-thread-safe">straight forward fix</a> to swap the policy out. As in the log line above though, sometimes the JVM&#8217;s finaliser thread sticks it&#8217;s oar in and confuses the <code>SingleThreadedPolicy</code>.</p>

<!-- more -->


<p>To get rid of this, you can set a custom threading policy that performs the same check as the default, just not when the finaliser thread is involved.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="n">Mockery</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Mockery</span><span class="o">()</span> <span class="o">{{</span>
</span><span class='line'>    <span class="n">setThreadingPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">SingleThreadedPolicyAvoidingFinaliseProblems</span><span class="o">());</span>
</span><span class='line'><span class="o">}};</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SingleThreadedPolicyAvoidingFinaliseProblems</span> <span class="kd">extends</span> <span class="n">SingleThreadedPolicy</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Invokable</span> <span class="nf">synchroniseAccessTo</span><span class="o">(</span><span class="n">Invokable</span> <span class="n">unsynchronizedInvocation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Invokable</span> <span class="n">synchronizedInvocation</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">synchroniseAccessTo</span><span class="o">(</span><span class="n">unsynchronizedInvocation</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">InvokeBasedOnCurrentThreadBeingTheFinalizerThread</span><span class="o">(</span><span class="n">unsynchronizedInvocation</span><span class="o">,</span> <span class="n">synchronizedInvocation</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">InvokeBasedOnCurrentThreadBeingTheFinalizerThread</span> <span class="kd">implements</span> <span class="n">Invokable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Invokable</span> <span class="n">whenOnFinalizerThread</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Invokable</span> <span class="n">whenNotFinalizerThread</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">InvokeBasedOnCurrentThreadBeingTheFinalizerThread</span><span class="o">(</span><span class="n">Invokable</span> <span class="n">whenOnFinalizerThread</span><span class="o">,</span> <span class="n">Invokable</span> <span class="n">whenNotFinalizerThread</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">whenOnFinalizerThread</span> <span class="o">=</span> <span class="n">whenOnFinalizerThread</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">whenNotFinalizerThread</span> <span class="o">=</span> <span class="n">whenNotFinalizerThread</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Invocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">currentThreadIs</span><span class="o">(</span><span class="s">&quot;Finalizer&quot;</span><span class="o">))</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">whenOnFinalizerThread</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">invocation</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">whenNotFinalizerThread</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">invocation</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">currentThreadIs</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>See the bug report <a href="http://jira.codehaus.org/browse/JMOCK-256">JMOCK-256</a> for more details.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Timeout in JMock Synchroniser]]></title>
    <link href="http://tempusfugitlibrary.org/recipes/2012/06/01/timeout-jmock-synchroniser/"/>
    <updated>2012-06-01T21:15:00+01:00</updated>
    <id>http://tempusfugitlibrary.org/recipes/2012/06/01/timeout-jmock-synchroniser</id>
    <content type="html"><![CDATA[<p>JMock&#8217;s <code>Synchroniser</code> serialises access to the mock object&#8217;s &#8220;context&#8221;, it means all invocations of mocked methods call will be <code>synchronized</code> on the same monitor, effectively forcing them to run in sequence without thread safety concerns. As it uses <code>synchronized</code> though, you can (with some effort) get into trouble with tests that never finish.</p>

<p>If you&#8217;re seeing this kind of thing, apart from using the <code>@Test(timeout=1000)</code> annotation, you might consider an alternative <code>ThreadingPolicy</code> implementation using <code>Lock</code>s that can timeout and maintain liveliness.</p>

<!-- more -->




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TimingOutSynchroniser</span> <span class="kd">implements</span> <span class="n">ThreadingPolicy</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Condition</span> <span class="n">awaitingStatePredicate</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Duration</span> <span class="n">lockTimeout</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Error</span> <span class="n">firstError</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">TimingOutSynchroniser</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">(</span><span class="n">millis</span><span class="o">(</span><span class="mi">250</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">TimingOutSynchroniser</span><span class="o">(</span><span class="n">Duration</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">lockTimeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">waitUntil</span><span class="o">(</span><span class="n">StatePredicate</span> <span class="n">predicate</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">waitUntil</span><span class="o">(</span><span class="n">predicate</span><span class="o">,</span> <span class="k">new</span> <span class="n">InfiniteTimeout</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Waits up to a timeout for a StatePredicate to become active.  Fails the</span>
</span><span class='line'><span class="cm">     * test if the timeout expires.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">waitUntil</span><span class="o">(</span><span class="n">StatePredicate</span> <span class="n">predicate</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeoutMs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">waitUntil</span><span class="o">(</span><span class="n">predicate</span><span class="o">,</span> <span class="k">new</span> <span class="n">FixedTimeout</span><span class="o">(</span><span class="n">timeoutMs</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">waitUntil</span><span class="o">(</span><span class="n">StatePredicate</span> <span class="n">predicate</span><span class="o">,</span> <span class="n">Timeout</span> <span class="n">testTimeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">lockTimeout</span><span class="o">.</span><span class="na">inMillis</span><span class="o">(),</span> <span class="n">MILLISECONDS</span><span class="o">);</span>
</span><span class='line'>            <span class="k">while</span> <span class="o">(!</span><span class="n">predicate</span><span class="o">.</span><span class="na">isActive</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">awaitingStatePredicate</span><span class="o">.</span><span class="na">await</span><span class="o">(</span><span class="n">testTimeout</span><span class="o">.</span><span class="na">timeRemaining</span><span class="o">(),</span> <span class="n">MILLISECONDS</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(</span><span class="n">firstError</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>                        <span class="k">throw</span> <span class="n">firstError</span><span class="o">;</span>
</span><span class='line'>                    <span class="n">Assert</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="s">&quot;timed out waiting for &quot;</span> <span class="o">+</span> <span class="n">asString</span><span class="o">(</span><span class="n">predicate</span><span class="o">));</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">())</span>
</span><span class='line'>                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Invokable</span> <span class="nf">synchroniseAccessTo</span><span class="o">(</span><span class="kd">final</span> <span class="n">Invokable</span> <span class="n">mockObject</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">Invokable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Invocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">synchroniseInvocation</span><span class="o">(</span><span class="n">mockObject</span><span class="o">,</span> <span class="n">invocation</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">};</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Object</span> <span class="nf">synchroniseInvocation</span><span class="o">(</span><span class="n">Invokable</span> <span class="n">mockObject</span><span class="o">,</span> <span class="n">Invocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">lockTimeout</span><span class="o">.</span><span class="na">inMillis</span><span class="o">(),</span> <span class="n">MILLISECONDS</span><span class="o">);</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">mockObject</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">invocation</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Error</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">firstError</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>                    <span class="n">firstError</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
</span><span class='line'>                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">awaitingStatePredicate</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">())</span>
</span><span class='line'>                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Make JMock Thread Safe]]></title>
    <link href="http://tempusfugitlibrary.org/recipes/2012/06/01/making-jmock-thread-safe/"/>
    <updated>2012-06-01T19:00:00+01:00</updated>
    <id>http://tempusfugitlibrary.org/recipes/2012/06/01/making-jmock-thread-safe</id>
    <content type="html"><![CDATA[<p>By default, JMock&#8217;s &#8220;context&#8221; is not thread safe. All bets are off if you access the <code>Mockery</code> from  multiple threads. Happily, since JMock 2.6.0, you can set a threading policy per mockery.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Mockery</span> <span class="n">mockery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JUnit4Mockery</span><span class="o">()</span> <span class="o">{{</span>
</span><span class='line'>  <span class="n">setThreadingPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">Synchroniser</span><span class="o">());</span>
</span><span class='line'><span class="o">}};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>Synchroniser</code> forces serialisation of each mocked method call using <code>synchronized</code>. Use it when you&#8217;re running multi-threaded style tests using JMock. The default behaviour will warn you if a mockery is being used like this.</p>

<pre><code>the Mockery is not thread-safe: use a Synchroniser to ensure thread safety
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Detecting Deadlocks]]></title>
    <link href="http://tempusfugitlibrary.org/recipes/2012/05/26/detecting-deadlocks/"/>
    <updated>2012-05-26T15:38:00+01:00</updated>
    <id>http://tempusfugitlibrary.org/recipes/2012/05/26/detecting-deadlocks</id>
    <content type="html"><![CDATA[<p>The <code>DeadlockDetector</code> class allows you to programmatically detect basic deadlocks in your Java code. You can output deadlocks using the following code (note that printing a thread dump using the <code>ThreadDump</code> class will automatically attempt to find any deadlocks).</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">DeadlockDetector</span><span class="o">.</span><span class="na">printDeadlocks</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>DeadlockDecector</code> class will spot Java monitor cyclic locking problems as well as <code>Lock</code> based cyclic problems. It&#8217;s implementation is basically the same as that used by <code>jconsole</code> and <code>jstack</code>. The types of deadlock it can detect can be illustrated in the example below.</p>

<!-- more -->


<h2>Monitor Deadlock Example</h2>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">potentialDeadlock</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">new</span> <span class="nf">Kidnapper</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>  <span class="k">new</span> <span class="nf">Negotiator</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Kidnapper</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>     <span class="kd">synchronized</span> <span class="o">(</span><span class="n">nibbles</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">cash</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">take</span><span class="o">(</span><span class="n">cash</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>     <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Negotiator</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>     <span class="kd">synchronized</span> <span class="o">(</span><span class="n">cash</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">nibbles</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">take</span><span class="o">(</span><span class="n">nibbles</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>     <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, the Kidnapper is unwilling to release poor Nibbles the Cat until he has the Cash but our Negotiator is unwilling to part with the Cash until he has poor Nibbles. The deadlock detector displays this situation as follows.</p>

<pre><code>Deadlock detected
=================

"Negotiator-Thread-1":
  waiting to lock Monitor of ...DeadlockDetectorTest$Cat@ce4a8a
  which is held by "Kidnapper-Thread-0"

"Kidnapper-Thread-0":
  waiting to lock Monitor of ...DeadlockDetectorTest$Cash@7fc8b2
  which is held by "Negotiator-Thread-1"
</code></pre>

<p><a href="https://github.com/tobyweston/tempus-fugit/blob/0036345f047fb26b9ca20690895d458cc0c2e104/src/test/java/com/google/code/tempusfugit/concurrency/DeadlockDetectorTest.java">See this example in full</a></p>

<h2>Lock Based Deadlock Example</h2>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="n">Cash</span> <span class="n">cash</span> <span class="o">=</span> <span class="o">...</span> <span class="c1">// Cash extends ReentrantLock</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="n">Cat</span> <span class="o">=</span> <span class="o">...</span> <span class="c1">// Cat extends ReentrantLock</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">potentialDeadlock</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">Kidnapper</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">Negotiator</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Kidnapper</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">keep</span><span class="o">(</span><span class="n">nibbles</span><span class="o">);</span>
</span><span class='line'>            <span class="n">take</span><span class="o">(</span><span class="n">cash</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">release</span><span class="o">(</span><span class="n">nibbles</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Negotiator</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">keep</span><span class="o">(</span><span class="n">cash</span><span class="o">);</span>
</span><span class='line'>            <span class="n">take</span><span class="o">(</span><span class="n">nibbles</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">release</span><span class="o">(</span><span class="n">cash</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where <code>keep</code>, <code>take</code> and <code>release</code> methods are pedagogically named methods wrapping the <code>Lock.lock</code> and <code>Lock.unlock</code> methods.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">keep</span><span class="o">(</span><span class="n">Lock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">take</span><span class="o">(</span><span class="n">Lock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">release</span><span class="o">(</span><span class="n">Lock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Same scenario as before, a deadlock ensues which is shown as.</p>

<pre><code>Deadlock detected
=================

"Negotiator-Thread-3":
  waiting to lock Monitor of java.util.concurrent.locks.ReentrantLock$NonfairSync@266bade9
  which is held by "Kidnapper-Thread-2"

"Kidnapper-Thread-2":
  waiting to lock Monitor of java.util.concurrent.locks.ReentrantLock$NonfairSync@6766afb3
  which is held by "Negotiator-Thread-3"
</code></pre>

<p><a href="https://github.com/tobyweston/tempus-fugit/blob/728f90331f7281b2b2a7268ba58cdebbfdff3793/src/test/java/com/google/code/tempusfugit/concurrency/DeadlockDetectorWithLocksTest.java">See this example in full</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Testing Concurrent Code]]></title>
    <link href="http://tempusfugitlibrary.org/recipes/2012/05/20/testing-concurrent-code/"/>
    <updated>2012-05-20T20:33:00+01:00</updated>
    <id>http://tempusfugitlibrary.org/recipes/2012/05/20/testing-concurrent-code</id>
    <content type="html"><![CDATA[<p>Testing concurrency can be hard. When you fire up threads from within a test, it&#8217;s difficult not to introduce concurrency bugs in the test code and be sure you&#8217;re actually exercising the code with the intended interleaving. There must be a better way&#8230;</p>

<h2>Separate the Concurrency Policy from Behaviour</h2>

<p><a href="http://www.growing-object-oriented-software.com/">GOOS</a> amongst other people recommend separating the concurrency policy from the parts of the system that are doing the work. So, for example, if you have some form of &#8220;executor&#8221; which is responsible for farming work out concurrently and behaviour defined separately, you can test each independently and just verify that they collaborate to achieve &#8220;worker&#8221; behaviour concurrently. Make sense?</p>

<!-- more -->


<p>As an example, <a href="https://github.com/tobyweston/tempus-fugit/blob/master/tempus-fugit/src/test/java/com/google/code/tempusfugit/concurrency/ConcurrentSchedulerTest.java">this test from tempus-fugit</a> demonstrates the idea. The <code>Scheduler</code>&#8217;s behaviour (which is essentially to &#8220;schedule&#8221; tasks) is independent from <em>how</em> it actually achieves this. In this case, it delegates to an <code>Executor</code> and so this doesn&#8217;t need to be tested with any threads. It&#8217;s a simple collaborator style test.</p>

<p>Having said that, there may be times you actually want to run your class &#8216;in context&#8217; in a multi-threaded way. The trick here is to keep the test deterministic. Well, I say that, there&#8217;s a couple of choices&#8230;</p>

<h2>Deterministic</h2>

<p>If you can setup your test to progress in a deterministic way, waiting at key points for conditions to be met before moving forward, you can try to simulate a specific process interleaving to test. This means understanding exactly what you want to test (for example, forcing the code into a deadlock) and stepping through deterministically (for example, using abstractions like <code>CountdownLatch</code> to <em>synchronise</em> the moving parts).</p>

<p>When you attempt to make some multi-threaded test syncrhonise its moving parts, you can use whatever concurrency abstraction is available to you but it&#8217;s difficult because its concurrent; things could happen in an unexpected order. Often people try to mitigate this in tests by introducing <code>sleep</code> calls. We generally don&#8217;t like to sleep in a test because it can introduce non-determinism. Just because the right sleep amount on one machine <em>usually</em> causes the affect you&#8217;re looking for, it doesn&#8217;t mean it&#8217;ll be the same on the next machine. It&#8217;ll also make the test run slower and when you&#8217;ve got thousands of tests to run, every ms counts. If you try and lower the sleep period, more non-determinism comes in. It&#8217;s not pretty.</p>

<p>Some examples of forcing specific interleaving include</p>

<ul>
<li><a href="https://github.com/tobyweston/tempus-fugit/blob/master/tempus-fugit/src/test/java/com/google/code/tempusfugit/concurrency/DeadlockDetectorTest.java">Forcing a deadlock</a> using <code>CountdownLatch</code></li>
<li><a href="https://github.com/tobyweston/tempus-fugit/blob/master/tempus-fugit/src/test/java/com/google/code/tempusfugit/concurrency/ThreadUtilsTest.java">Setting up a thread to be interrupted</a></li>
</ul>


<p>Another gotcha is where the main test thread will finish before any newly spawned threads under test complete. This is an easy trap to fall into with UI testing. Waiting for a specific condition rather than allowing the test thread to finish often helps. For example using <a href="http://tempusfugitlibrary.org/documentation/time/waiting">WaitFor</a>. See the article <a href="http://baddotrobot.com/blog/2008/12/30/be-explicit-about-ui-thread-in-swt/">Be Explicit with the UI Thread</a> for more details around this for UI testing.</p>

<h2>Soak / Load Testing</h2>

<p>Another choice is to bombard your classes in an attempt to overload them and force them to betray some subtle concurrency issue. Here, just as in the other style, you&#8217;ll need to setup up specific assertions so that you can tell if and when the classes betray themselves. Of course there is no guarantee that you&#8217;ll simulate a problem, you might never see the unlike timing needed.</p>

<p>The tempus-fugit library offers a declarative way to setup tests to run repeatedly and in parallel, see <a href="http://tempusfugitlibrary.org/documentation/junit/load">Load / Soak Tests</a>.</p>
]]></content>
  </entry>
  
</feed>
